<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LLM –ß–∞—Ç-–∫–ª–∏–µ–Ω—Ç</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
      }

      body {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        color: #e6e6e6;
        min-height: 100vh;
        padding: 20px;
        line-height: 1.5;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        height: calc(100vh - 40px);
      }

      header {
        text-align: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #2d3748;
      }

      h1 {
        font-size: 2.2rem;
        margin-bottom: 8px;
        background: linear-gradient(90deg, #6ee7b7, #3b82f6);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
      }

      .subtitle {
        color: #a0aec0;
        font-size: 1rem;
      }

      .main-content {
        display: flex;
        flex: 1;
        gap: 20px;
        overflow: hidden;
      }

      @media (max-width: 768px) {
        .main-content {
          flex-direction: column;
        }
      }

      .settings-panel {
        flex: 0 0 320px;
        background: rgba(26, 32, 44, 0.8);
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #2d3748;
        display: flex;
        flex-direction: column;
        gap: 20px;
        overflow-y: scroll;
      }

      .chat-container {
        flex: 1;
        background: rgba(26, 32, 44, 0.8);
        border-radius: 12px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        border: 1px solid #2d3748;
        overflow: hidden;
      }

      .settings-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      label {
        font-weight: 600;
        color: #cbd5e0;
        font-size: 0.9rem;
      }

      input,
      textarea,
      select {
        background: #2d3748;
        border: 1px solid #4a5568;
        border-radius: 8px;
        padding: 10px 12px;
        color: #e6e6e6;
        font-size: 0.95rem;
        transition: border-color 0.2s;
      }

      input:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: #4299e1;
        box-shadow: 0 0 0 2px rgba(66, 153, 225, 0.2);
      }

      .api-key-container {
        position: relative;
      }

      .toggle-visibility {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #a0aec0;
        cursor: pointer;
        font-size: 0.9rem;
      }

      button {
        background: linear-gradient(90deg, #3182ce, #2b6cb0);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 12px 20px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.95rem;
      }

      button:hover {
        background: linear-gradient(90deg, #2b6cb0, #2c5282);
      }

      button:active {
        transform: translateY(0);
      }

      button:disabled {
        background: #4a5568;
        cursor: not-allowed;
        transform: none;
      }

      .secondary-button {
        background: #4a5568;
      }

      .secondary-button:hover {
        background: #2d3748;
      }

      .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
        margin-bottom: 20px;
        background: rgba(45, 55, 72, 0.5);
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .message {
        max-width: 85%;
        padding: 12px 16px;
        border-radius: 18px;
        line-height: 1.5;
        word-wrap: break-word;
        position: relative;
      }

      .message-stats {
        font-size: 0.8rem;
        color: #a0aec0;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }

      .message-stats strong {
        color: #cbd5e0;
      }

      .user-message {
        align-self: flex-end;
        background: linear-gradient(135deg, #3182ce, #2b6cb0);
        color: white;
        border-bottom-right-radius: 4px;
      }

      .assistant-message {
        align-self: flex-start;
        background: #2d3748;
        color: #e6e6e6;
        border-bottom-left-radius: 4px;
      }

      .message-header {
        font-size: 0.8rem;
        font-weight: 600;
        margin-bottom: 4px;
        display: flex;
        justify-content: space-between;
      }

      .input-area {
        display: flex;
        gap: 10px;
        align-items: flex-end;
      }

      #messageInput {
        flex: 1;
        min-height: 50px;
        max-height: 150px;
        resize: vertical;
      }

      #sendButton {
        height: 50px;
        min-width: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .status-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
        color: #a0aec0;
        padding: 8px 12px;
        background: rgba(45, 55, 72, 0.7);
        border-radius: 8px;
        margin-top: 10px;
      }

      .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #48bb78;
      }

      .dot.disconnected {
        background: #f56565;
      }

      .dot.connecting {
        background: #ed8936;
        animation: pulse 1.5s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .system-message {
        background: rgba(237, 137, 54, 0.1);
        border: 1px solid rgba(237, 137, 54, 0.3);
        border-radius: 8px;
        padding: 12px;
        font-size: 0.9rem;
        margin-bottom: 10px;
      }

      .error-message {
        background: rgba(245, 101, 101, 0.1);
        border: 1px solid rgba(245, 101, 101, 0.3);
        border-radius: 8px;
        padding: 12px;
        font-size: 0.9rem;
        margin-bottom: 10px;
      }

      .hidden {
        display: none;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .message-time {
        font-size: 0.75rem;
        opacity: 0.7;
      }

      .clear-button {
        background: #4a5568;
        margin-top: 10px;
      }

      .clear-button:hover {
        background: #2d3748;
      }

      .prompt-templates-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px;
        margin-bottom: 8px;
      }

      .template-pill {
        background: #2d3748;
        border: 1px solid #4a5568;
        border-radius: 16px;
        padding: 6px 12px;
        font-size: 0.85rem;
        color: #cbd5e0;
        cursor: pointer;
        transition: all 0.2s;
      }

      .template-pill:hover {
        background: #4a5568;
        border-color: #4299e1;
      }

      .template-pill.active {
        background: #4299e1;
        color: white;
        border-color: #4299e1;
      }

      .custom-prompt-controls {
        display: flex;
        gap: 10px;
        margin-top: 8px;
      }

      .custom-prompt-controls button {
        flex: 1;
        padding: 8px 12px;
        font-size: 0.85rem;
      }

      .template-description {
        font-size: 0.8rem;
        color: #a0aec0;
        margin-top: 4px;
        margin-bottom: 8px;
        line-height: 1.4;
      }
      footer {
        text-align: center;
        margin-top: 20px;
        color: #a0aec0;
        font-size: 0.9rem;
        padding-top: 15px;
        border-top: 1px solid #2d3748;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>LLM –ß–∞—Ç-–∫–ª–∏–µ–Ω—Ç</h1>
        <p class="subtitle">
          –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –ª—é–±–æ–π LLM API —Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
        </p>
      </header>

      <div class="main-content">
        <div class="settings-panel">
          <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h2>

          <div class="settings-group">
            <label for="apiUrl">URL API —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞:</label>
            <input
              type="text"
              id="apiUrl"
              placeholder="https://api.openai.com/v1/chat/completions"
              value="https://api.openai.com/v1/chat/completions"
            />
          </div>

          <div class="settings-group">
            <label for="apiKey">API –∫–ª—é—á:</label>
            <div class="api-key-container">
              <input
                type="password"
                id="apiKey"
                placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à API –∫–ª—é—á"
              />
              <button type="button" class="toggle-visibility" id="toggleApiKey">
                –ü–æ–∫–∞–∑–∞—Ç—å
              </button>
            </div>
          </div>

          <div class="settings-group">
            <label for="model">–ú–æ–¥–µ–ª—å:</label>
            <input
              type="text"
              id="model"
              placeholder="gpt-3.5-turbo"
              value="gpt-3.5-turbo"
            />
          </div>

          <div class="settings-group">
            <label for="systemPrompt">System Prompt:</label>

            <!-- Prompt templates selection -->
            <div
              class="prompt-templates-container"
              id="promptTemplatesContainer"
            >
              <!-- Templates will be added dynamically -->
            </div>

            <!-- Template description -->
            <div class="template-description hidden" id="templateDescription">
              <strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong>
              <span id="templateDescriptionText"></span>
            </div>

            <!-- Custom prompt controls -->
            <div class="custom-prompt-controls">
              <button
                type="button"
                id="saveCustomPrompt"
                class="secondary-button"
              >
                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π
              </button>
              <button type="button" id="managePrompts" class="secondary-button">
                üìã –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
              </button>
            </div>

            <textarea
              id="systemPrompt"
              placeholder="–£–∫–∞–∂–∏—Ç–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–µ–ª–∏ (—Ä–æ–ª—å, –∫–æ–Ω—Ç–µ–∫—Å—Ç, –ø–æ–≤–µ–¥–µ–Ω–∏–µ)"
              rows="3"
            ></textarea>
            <div style="font-size: 0.8rem; color: #a0aec0; margin-top: 4px">
              –≠—Ç–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –º–æ–¥–µ–ª–∏ –≤ –Ω–∞—á–∞–ª–µ –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
            </div>
          </div>

          <div class="settings-group">
            <label for="temperature">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (0-2):</label>
            <input type="range" id="temperature" min="0" max="20" value="10" />
            <div
              style="
                display: flex;
                justify-content: space-between;
                font-size: 0.8rem;
              "
            >
              <span>0 (–¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è)</span>
              <span id="temperatureValue">1.0</span>
              <span>2 (–∫—Ä–µ–∞—Ç–∏–≤–Ω–∞—è)</span>
            </div>
          </div>

          <div class="settings-group">
            <label for="maxTokens">–ú–∞–∫—Å. —Ç–æ–∫–µ–Ω–æ–≤:</label>
            <input
              type="number"
              id="maxTokens"
              min="1"
              max="4096"
              value="1000"
            />
          </div>

          <button id="testConnection">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>

          <div class="status-indicator">
            <div class="dot disconnected" id="statusDot"></div>
            <span id="statusText">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</span>
          </div>

          <div class="system-message hidden" id="systemMessage">
            <strong>–°–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:</strong>
            <span id="systemMessageText"></span>
          </div>

          <div class="error-message hidden" id="errorMessage">
            <strong>–û—à–∏–±–∫–∞:</strong> <span id="errorMessageText"></span>
          </div>

          <button
            id="showStats"
            class="secondary-button"
            style="margin-top: 10px"
          >
            üìä –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
          </button>

          <button class="clear-button secondary-button" id="clearChat">
            –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç
          </button>
        </div>

        <div class="chat-container">
          <h2>–ß–∞—Ç</h2>

          <div class="messages-container" id="messagesContainer">
            <div class="message assistant-message">
              <div class="message-header">
                <span>–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</span>
                <span class="message-time" id="welcomeTime"></span>
              </div>
              –ü—Ä–∏–≤–µ—Ç! –Ø –≤–∞—à AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤
              –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏, –∑–∞—Ç–µ–º –Ω–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ.
            </div>
          </div>

          <div class="input-area">
            <textarea
              id="messageInput"
              placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ... –ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏, Shift+Enter –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏."
              rows="2"
            ></textarea>
            <button id="sendButton">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          </div>
        </div>
      </div>

      <footer>
        <p>
          LLM –ß–∞—Ç-–∫–ª–∏–µ–Ω—Ç | –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —á–∏—Å—Ç–æ–º HTML, CSS –∏ JavaScript |
          –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ª—é–±—ã–µ LLM API
        </p>
      </footer>
    </div>

    <script>
      // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
      const apiUrlInput = document.getElementById("apiUrl");
      const apiKeyInput = document.getElementById("apiKey");
      const modelInput = document.getElementById("model");
      const temperatureInput = document.getElementById("temperature");
      const temperatureValue = document.getElementById("temperatureValue");
      const maxTokensInput = document.getElementById("maxTokens");
      const toggleApiKeyButton = document.getElementById("toggleApiKey");
      const testConnectionButton = document.getElementById("testConnection");
      const statusDot = document.getElementById("statusDot");
      const statusText = document.getElementById("statusText");
      const systemMessage = document.getElementById("systemMessage");
      const systemMessageText = document.getElementById("systemMessageText");
      const errorMessage = document.getElementById("errorMessage");
      const errorMessageText = document.getElementById("errorMessageText");
      const messagesContainer = document.getElementById("messagesContainer");
      const messageInput = document.getElementById("messageInput");
      const sendButton = document.getElementById("sendButton");
      const clearChatButton = document.getElementById("clearChat");
      const welcomeTime = document.getElementById("welcomeTime");
      const systemPromptInput = document.getElementById("systemPrompt");
      const promptTemplatesContainer = document.getElementById(
        "promptTemplatesContainer"
      );
      const templateDescription = document.getElementById(
        "templateDescription"
      );
      const templateDescriptionText = document.getElementById(
        "templateDescriptionText"
      );
      const saveCustomPromptButton =
        document.getElementById("saveCustomPrompt");
      const managePromptsButton = document.getElementById("managePrompts");
      const showStatsButton = document.getElementById("showStats");

      // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      let isConnected = false;
      let conversationHistory = [];
      let promptTemplates = [];
      let currentTemplateId = null;
      let requestStartTime = null;
      let totalTokensUsed = 0;
      let totalRequests = 0;

      // –ü—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã –ø—Ä–æ–º–ø—Ç–æ–≤
      const defaultTemplates = [
        {
          id: "assistant",
          name: "üë®‚Äçüíº –û–±—â–∏–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç",
          prompt:
            "–¢—ã –ø–æ–ª–µ–∑–Ω—ã–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã —Ç–æ—á–Ω–æ –∏ –ø–æ –¥–µ–ª—É.",
          description: "–ë–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –æ–±—â–µ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è",
        },
        {
          id: "programmer",
          name: "üë®‚Äçüíª –ü—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç",
          prompt:
            "–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—é. –ü–æ–º–æ–≥–∞–π –ø–∏—Å–∞—Ç—å –∫–æ–¥, –æ–±—ä—è—Å–Ω—è—Ç—å –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –∏ –Ω–∞—Ö–æ–¥–∏—Ç—å –æ—à–∏–±–∫–∏. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ –∏–Ω–æ–µ.",
          description:
            "–°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—é",
        },
        {
          id: "writer",
          name: "‚úçÔ∏è –ö—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –ø–∏—Å–∞—Ç–µ–ª—å",
          prompt:
            "–¢—ã –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –ø–∏—Å–∞—Ç–µ–ª—å –∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä. –ü–æ–º–æ–≥–∞–π –ø—Ä–∏–¥—É–º—ã–≤–∞—Ç—å –∏–¥–µ–∏, –ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç—ã, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç. –ë—É–¥—å –∏–∑–æ–±—Ä–µ—Ç–∞—Ç–µ–ª—å–Ω—ã–º –∏ –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–º.",
          description: "–ü—Ä–æ–º–ø—Ç –¥–ª—è —Ç–≤–æ—Ä—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á –∏ –Ω–∞–ø–∏—Å–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–æ–≤",
        },
        {
          id: "analyst",
          name: "üìä –ê–Ω–∞–ª–∏—Ç–∏–∫ –¥–∞–Ω–Ω—ã—Ö",
          prompt:
            "–¢—ã –∞–Ω–∞–ª–∏—Ç–∏–∫ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–º–æ–≥–∞–π –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ, —Å—Ç—Ä–æ–∏—Ç—å –≥–∏–ø–æ—Ç–µ–∑—ã –∏ –¥–µ–ª–∞—Ç—å –≤—ã–≤–æ–¥—ã. –ë—É–¥—å —Ç–æ—á–Ω—ã–º –∏ –ª–æ–≥–∏—á–Ω—ã–º, –∏—Å–ø–æ–ª—å–∑—É–π –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–≤–æ–∏—Ö –≤—ã–≤–æ–¥–æ–≤.",
          description: "–ü—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π",
        },
        {
          id: "teacher",
          name: "üë®‚Äçüè´ –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å",
          prompt:
            "–¢—ã –æ–ø—ã—Ç–Ω—ã–π –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å. –û–±—ä—è—Å–Ω—è–π —Å–ª–æ–∂–Ω—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏, –∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∏–º–µ—Ä—ã –∏ –∞–Ω–∞–ª–æ–≥–∏–∏. –ü—Ä–æ–≤–µ—Ä—è–π –ø–æ–Ω–∏–º–∞–Ω–∏–µ —É—á–µ–Ω–∏–∫–∞ –∏ –∞–¥–∞–ø—Ç–∏—Ä—É–π –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –ø–æ–¥ –µ–≥–æ —É—Ä–æ–≤–µ–Ω—å.",
          description: "–ü—Ä–æ–º–ø—Ç –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è —Å–ª–æ–∂–Ω—ã—Ö —Ç–µ–º",
        },
        {
          id: "minimal",
          name: "‚ö° –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π",
          prompt: "–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É.",
          description: "–ö—Ä–∞—Ç–∫–∏–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∏ –ø—Ä—è–º—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤",
        },
      ];

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      function init() {
        // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Ä–µ–º—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        welcomeTime.textContent = formatTime(new Date());

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        temperatureInput.addEventListener("input", updateTemperatureValue);
        toggleApiKeyButton.addEventListener("click", toggleApiKeyVisibility);
        testConnectionButton.addEventListener("click", testConnection);
        sendButton.addEventListener("click", sendMessage);
        clearChatButton.addEventListener("click", clearChat);
        messageInput.addEventListener("keydown", handleKeyDown);
        saveCustomPromptButton.addEventListener("click", saveCustomPrompt);
        managePromptsButton.addEventListener("click", showPromptManager);
        showStatsButton.addEventListener("click", showStatistics);

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ localStorage
        loadSettings();

        // –ó–∞–≥—Ä—É–∑–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤ –ø—Ä–æ–º–ø—Ç–æ–≤
        loadPromptTemplates();

        // –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
        updateTemperatureValue();

        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞
        loadChatHistory();

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω—ã –ø—Ä–æ–º–ø—Ç–æ–≤
        renderPromptTemplates();
      }

      // –ó–∞–≥—Ä—É–∑–∏—Ç—å —à–∞–±–ª–æ–Ω—ã –ø—Ä–æ–º–ø—Ç–æ–≤ –∏–∑ localStorage
      function loadPromptTemplates() {
        const savedTemplates = localStorage.getItem("llmPromptTemplates");
        if (savedTemplates) {
          try {
            promptTemplates = JSON.parse(savedTemplates);
          } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —à–∞–±–ª–æ–Ω–æ–≤ –ø—Ä–æ–º–ø—Ç–æ–≤:", e);
            promptTemplates = [...defaultTemplates];
          }
        } else {
          // –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ
          promptTemplates = [...defaultTemplates];
        }
      }

      // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω—ã –ø—Ä–æ–º–ø—Ç–æ–≤ –≤ localStorage
      function savePromptTemplates() {
        localStorage.setItem(
          "llmPromptTemplates",
          JSON.stringify(promptTemplates)
        );
      }

      // –û—Ç—Ä–µ–Ω–¥–µ—Ä–∏—Ç—å —à–∞–±–ª–æ–Ω—ã –ø—Ä–æ–º–ø—Ç–æ–≤
      function renderPromptTemplates() {
        promptTemplatesContainer.innerHTML = "";

        promptTemplates.forEach((template) => {
          const pill = document.createElement("div");
          pill.className = `template-pill ${currentTemplateId === template.id ? "active" : ""}`;
          pill.textContent = template.name;
          pill.dataset.id = template.id;

          pill.addEventListener("click", () => {
            selectPromptTemplate(template.id);
          });

          promptTemplatesContainer.appendChild(pill);
        });
      }

      // –í—ã–±—Ä–∞—Ç—å —à–∞–±–ª–æ–Ω –ø—Ä–æ–º–ø—Ç–∞
      function selectPromptTemplate(templateId) {
        const template = promptTemplates.find((t) => t.id === templateId);
        if (!template) return;

        // –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–æ–º–ø—Ç
        systemPromptInput.value = template.prompt;
        currentTemplateId = templateId;

        // –ü–æ–∫–∞–∑–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ
        templateDescriptionText.textContent = template.description;
        templateDescription.classList.remove("hidden");

        // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∏–ª–∏ –∫–Ω–æ–ø–æ–∫
        document.querySelectorAll(".template-pill").forEach((pill) => {
          pill.classList.remove("active");
          if (pill.dataset.id === templateId) {
            pill.classList.add("active");
          }
        });

        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π –≤—ã–±–æ—Ä
        const settings = JSON.parse(
          localStorage.getItem("llmChatSettings") || "{}"
        );
        settings.selectedTemplateId = templateId;
        localStorage.setItem("llmChatSettings", JSON.stringify(settings));
      }

      // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–º–ø—Ç –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π
      function saveCustomPrompt() {
        const currentPrompt = systemPromptInput.value.trim();
        if (!currentPrompt) {
          showError("–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–ø—Ç –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
          return;
        }

        const name = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞:", "–ú–æ–π –ø—Ä–æ–º–ø—Ç");
        if (!name) return;

        const description = prompt(
          "–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞:",
          "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç"
        );

        const newTemplate = {
          id: "custom_" + Date.now(),
          name: name + " ‚≠ê",
          prompt: currentPrompt,
          description: description || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç",
        };

        promptTemplates.push(newTemplate);
        savePromptTemplates();
        renderPromptTemplates();
        selectPromptTemplate(newTemplate.id);

        showSystemMessage("–ü—Ä–æ–º–ø—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —à–∞–±–ª–æ–Ω—ã");
      }

      // –ü–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ–º–ø—Ç–æ–≤
      function showPromptManager() {
        let managerHtml = `
              <div style="padding: 10px;">
                <h3 style="margin-bottom: 15px;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞–º–∏ –ø—Ä–æ–º–ø—Ç–æ–≤</h3>
                <div style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;">
            `;

        promptTemplates.forEach((template, index) => {
          const isDefault = defaultTemplates.some((t) => t.id === template.id);
          managerHtml += `
                <div style="padding: 10px; border-bottom: 1px solid #4a5568; margin-bottom: 10px;">
                  <div style="font-weight: bold; margin-bottom: 5px;">
                    ${template.name} ${isDefault ? "üîí" : ""}
                  </div>
                  <div style="font-size: 0.85rem; color: #a0aec0; margin-bottom: 5px;">
                    ${template.description}
                  </div>
                  <div style="font-size: 0.8rem; color: #cbd5e0; background: rgba(45, 55, 72, 0.5);
                       padding: 8px; border-radius: 4px; margin-bottom: 8px;">
                    ${template.prompt.substring(0, 100)}${template.prompt.length > 100 ? "..." : ""}
                  </div>
                  ${
                    !isDefault
                      ? `
                    <div style="display: flex; gap: 10px;">
                      <button onclick="editPromptTemplate('${template.id}')"
                              style="flex: 1; padding: 5px; font-size: 0.8rem;">
                        –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                      </button>
                      <button onclick="deletePromptTemplate('${template.id}')"
                              style="flex: 1; padding: 5px; font-size: 0.8rem; background: #f56565;">
                        –£–¥–∞–ª–∏—Ç—å
                      </button>
                    </div>
                  `
                      : ""
                  }
                </div>
              `;
        });

        managerHtml += `
                </div>
                <div style="display: flex; gap: 10px;">
                  <button onclick="resetToDefaultTemplates()"
                          style="flex: 1; padding: 8px;">
                    üîÑ –°–±—Ä–æ—Å–∏—Ç—å –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º
                  </button>
                  <button onclick="closePromptManager()"
                          style="flex: 1; padding: 8px;">
                    –ó–∞–∫—Ä—ã—Ç—å
                  </button>
                </div>
              </div>
            `;

        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        const modal = document.createElement("div");
        modal.style.position = "fixed";
        modal.style.top = "0";
        modal.style.left = "0";
        modal.style.width = "100%";
        modal.style.height = "100%";
        modal.style.backgroundColor = "rgba(0,0,0,0.7)";
        modal.style.display = "flex";
        modal.style.alignItems = "center";
        modal.style.justifyContent = "center";
        modal.style.zIndex = "1000";

        const modalContent = document.createElement("div");
        modalContent.style.background = "#1a202c";
        modalContent.style.borderRadius = "12px";
        modalContent.style.padding = "20px";
        modalContent.style.width = "90%";
        modalContent.style.maxWidth = "500px";
        modalContent.style.maxHeight = "80vh";
        modalContent.style.overflow = "auto";
        modalContent.style.border = "1px solid #4a5568";
        modalContent.innerHTML = managerHtml;

        modal.appendChild(modalContent);
        document.body.appendChild(modal);

        // –î–æ–±–∞–≤–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π
        window.editPromptTemplate = function (templateId) {
          const template = promptTemplates.find((t) => t.id === templateId);
          if (!template) return;

          const newName = prompt(
            "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:",
            template.name.replace(" ‚≠ê", "")
          );
          if (newName) template.name = newName + " ‚≠ê";

          const newDesc = prompt(
            "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:",
            template.description
          );
          if (newDesc) template.description = newDesc;

          const newPrompt = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç:", template.prompt);
          if (newPrompt) template.prompt = newPrompt;

          savePromptTemplates();
          renderPromptTemplates();
          showSystemMessage("–®–∞–±–ª–æ–Ω –æ–±–Ω–æ–≤–ª–µ–Ω");
        };

        window.deletePromptTemplate = function (templateId) {
          if (confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —à–∞–±–ª–æ–Ω?")) {
            promptTemplates = promptTemplates.filter(
              (t) => t.id !== templateId
            );
            savePromptTemplates();
            renderPromptTemplates();
            if (currentTemplateId === templateId) {
              currentTemplateId = null;
              systemPromptInput.value = "";
              templateDescription.classList.add("hidden");
            }
            showSystemMessage("–®–∞–±–ª–æ–Ω —É–¥–∞–ª–µ–Ω");
          }
        };

        window.resetToDefaultTemplates = function () {
          if (
            confirm(
              "–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —à–∞–±–ª–æ–Ω—ã –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º? –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —à–∞–±–ª–æ–Ω—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã."
            )
          ) {
            promptTemplates = [...defaultTemplates];
            savePromptTemplates();
            renderPromptTemplates();
            currentTemplateId = null;
            systemPromptInput.value = "";
            templateDescription.classList.add("hidden");
            showSystemMessage("–®–∞–±–ª–æ–Ω—ã —Å–±—Ä–æ—à–µ–Ω—ã –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º");
          }
        };

        window.closePromptManager = function () {
          document.body.removeChild(modal);
        };
      }

      // –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
      function updateTemperatureValue() {
        const value = parseFloat(temperatureInput.value) / 10;
        temperatureValue.textContent = value.toFixed(1);
      }

      // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç—å API –∫–ª—é—á–∞
      function toggleApiKeyVisibility() {
        if (apiKeyInput.type === "password") {
          apiKeyInput.type = "text";
          toggleApiKeyButton.textContent = "–°–∫—Ä—ã—Ç—å";
        } else {
          apiKeyInput.type = "password";
          toggleApiKeyButton.textContent = "–ü–æ–∫–∞–∑–∞—Ç—å";
        }
      }

      // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API
      async function testConnection() {
        const startTime = Date.now();
        const apiUrl = apiUrlInput.value.trim();
        const apiKey = apiKeyInput.value.trim();
        const model = modelInput.value.trim();
        const systemPrompt = systemPromptInput.value.trim();

        if (!apiUrl) {
          showError("–í–≤–µ–¥–∏—Ç–µ URL API —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞");
          return;
        }

        if (!apiKey) {
          showError("–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á");
          return;
        }

        if (!model) {
          showError("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏");
          return;
        }

        // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ "–ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è"
        updateStatus("connecting", "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...");
        testConnectionButton.disabled = true;
        testConnectionButton.innerHTML = '<div class="loading"></div>';

        try {
          // –°–æ–∑–¥–∞—Ç—å –º–∞—Å—Å–∏–≤ —Å–æ–æ–±—â–µ–Ω–∏–π —Å —É—á–µ—Ç–æ–º system prompt
          const messages = [];
          if (systemPrompt) {
            messages.push({ role: "system", content: systemPrompt });
          }
          messages.push({ role: "user", content: "–ü—Ä–∏–≤–µ—Ç" });

          // –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
          const response = await fetch(apiUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${apiKey}`,
            },
            body: JSON.stringify({
              model: model,
              messages: messages,
              max_tokens: 10,
              temperature: parseFloat(temperatureInput.value) / 10,
            }),
          });

          const endTime = Date.now();
          const duration = endTime - startTime;

          if (response.ok) {
            const data = await response.json();
            const tokensUsed = data.usage?.total_tokens || 0;

            updateStatus("connected", "–ü–æ–¥–∫–ª—é—á–µ–Ω–æ");
            showSystemMessage(
              `–£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –º–æ–¥–µ–ª–∏ "${model}" | –í—Ä–µ–º—è: ${duration}–º—Å | –¢–æ–∫–µ–Ω—ã: ${tokensUsed}`
            );
            isConnected = true;

            // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            saveSettings();
          } else {
            const errorData = await response.json();
            updateStatus("disconnected", "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è");
            showError(
              `–û—à–∏–±–∫–∞ API: ${errorData.error?.message || response.statusText} | –í—Ä–µ–º—è: ${duration}–º—Å`
            );
          }
        } catch (error) {
          updateStatus("disconnected", "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è");
          showError(`–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ${error.message}`);
        } finally {
          testConnectionButton.disabled = false;
          testConnectionButton.textContent = "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ";
        }
      }

      // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
      async function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;

        if (!isConnected) {
          showError("–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API");
          return;
        }

        // –ó–∞–ø–æ–º–Ω–∏—Ç—å –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –∑–∞–ø—Ä–æ—Å–∞
        requestStartTime = Date.now();

        // –î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —á–∞—Ç
        addMessageToChat("user", message);

        // –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ –≤–≤–æ–¥–∞
        messageInput.value = "";

        // –î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ (–ø–æ–∫–∞ –ø—É—Å—Ç–æ–µ)
        const assistantMessageId = addMessageToChat(
          "assistant",
          '<div class="loading"></div>',
          true
        );

        // –û—Ç–∫–ª—é—á–∏—Ç—å –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
        sendButton.disabled = true;
        messageInput.disabled = true;

        try {
          const apiUrl = apiUrlInput.value.trim();
          const apiKey = apiKeyInput.value.trim();
          const model = modelInput.value.trim();
          const temperature = parseFloat(temperatureInput.value) / 10;
          const maxTokens = parseInt(maxTokensInput.value);
          const systemPrompt = systemPromptInput.value.trim();

          // –î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏—Å—Ç–æ—Ä–∏—é
          conversationHistory.push({ role: "user", content: message });

          const messages = [];
          if (systemPrompt) {
            messages.push({ role: "system", content: systemPrompt });
          }
          messages.push(...conversationHistory);

          // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∫ API
          const response = await fetch(apiUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${apiKey}`,
            },
            body: JSON.stringify({
              model: model,
              messages: messages,
              max_tokens: maxTokens,
              temperature: temperature,
            }),
          });

          const endTime = Date.now();
          const duration = endTime - (requestStartTime || endTime);

          if (response.ok) {
            const data = await response.json();

            // –ò–∑–≤–ª–µ—á—å –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
            let assistantMessage = "";
            if (data.choices && data.choices.length > 0) {
              assistantMessage = data.choices[0].message.content;
            } else if (data.content) {
              assistantMessage = data.content;
            } else {
              assistantMessage = "–ü–æ–ª—É—á–µ–Ω –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç API";
            }

            // –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤
            const tokensUsed = data.usage?.total_tokens || 0;
            const promptTokens = data.usage?.prompt_tokens || 0;
            const completionTokens = data.usage?.completion_tokens || 0;

            // –û–±–Ω–æ–≤–∏—Ç—å –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            totalTokensUsed += tokensUsed;
            totalRequests++;

            // –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ —Å–æ–æ–±—â–µ–Ω–∏–µ
            const statsHtml = `
            <div class="message-stats" style="
              font-size: 0.8rem;
              color: #a0aec0;
              margin-top: 10px;
              padding-top: 10px;
              border-top: 1px solid rgba(255,255,255,0.1);
            ">
              ‚è±Ô∏è –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: <strong>${duration}–º—Å</strong> |
              ü™ô –¢–æ–∫–µ–Ω—ã: <strong>${tokensUsed}</strong>
              (–≤–≤–æ–¥: ${promptTokens}, –≤—ã–≤–æ–¥: ${completionTokens})
            </div>
          `;

            // –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –≤ –∏—Å—Ç–æ—Ä–∏—é
            conversationHistory.push({
              role: "assistant",
              content: assistantMessage,
            });

            // –û–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –≤ —á–∞—Ç–µ
            updateMessageInChat(
              assistantMessageId,
              assistantMessage + statsHtml
            );

            // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å –Ω–æ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
            updateStatus(
              "connected",
              `–ü–æ–¥–∫–ª—é—á–µ–Ω–æ | –ó–∞–ø—Ä–æ—Å–æ–≤: ${totalRequests} | –¢–æ–∫–µ–Ω–æ–≤ –≤—Å–µ–≥–æ: ${totalTokensUsed}`
            );

            // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞
            saveChatHistory();
          } else {
            const errorData = await response.json();
            const errorStats = `
            <div class="message-stats" style="
              font-size: 0.8rem;
              color: #f56565;
              margin-top: 10px;
              padding-top: 10px;
              border-top: 1px solid rgba(245,101,101,0.3);
            ">
              ‚è±Ô∏è –í—Ä–µ–º—è –¥–æ –æ—à–∏–±–∫–∏: <strong>${duration}–º—Å</strong>
            </div>
          `;

            updateMessageInChat(
              assistantMessageId,
              `–û—à–∏–±–∫–∞ API: ${errorData.error?.message || response.statusText}` +
                errorStats
            );
          }
        } catch (error) {
          const endTime = Date.now();
          const duration = endTime - (requestStartTime || endTime);
          const errorStats = `
          <div class="message-stats" style="
            font-size: 0.8rem;
            color: #f56565;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(245,101,101,0.3);
          ">
            ‚è±Ô∏è –í—Ä–µ–º—è –¥–æ –æ—à–∏–±–∫–∏: <strong>${duration}–º—Å</strong>
          </div>
        `;

          updateMessageInChat(
            assistantMessageId,
            `–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ${error.message}` + errorStats
          );
        } finally {
          // –í–∫–ª—é—á–∏—Ç—å –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞
          sendButton.disabled = false;
          messageInput.disabled = false;
          messageInput.focus();

          // –°–±—Ä–æ—Å–∏—Ç—å –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –∑–∞–ø—Ä–æ—Å–∞
          requestStartTime = null;
        }
      }

      // –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç
      function clearChat() {
        if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞?")) {
          // –û—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
          const messages = messagesContainer.querySelectorAll(".message");
          for (let i = 0; i < messages.length; i++) {
            if (!messages[i].querySelector("#welcomeTime")) {
              messages[i].remove();
            }
          }

          // –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
          conversationHistory = [];
          totalTokensUsed = 0;
          totalRequests = 0;

          // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å
          updateStatus("disconnected", "–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ");

          // –û—á–∏—Å—Ç–∏—Ç—å localStorage
          localStorage.removeItem("llmChatHistory");

          // –î–æ–±–∞–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
          showSystemMessage("–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ –æ—á–∏—â–µ–Ω–∞");
        }
      }

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –∫–ª–∞–≤–∏—à –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
      function handleKeyDown(event) {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          sendMessage();
        }
      }

      // –î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
      function addMessageToChat(role, content, isTemp = false) {
        const messageElement = document.createElement("div");
        const messageId = isTemp ? "temp-" + Date.now() : "";

        messageElement.className = `message ${role}-message`;
        if (isTemp) messageElement.id = messageId;

        const now = new Date();
        const timeString = formatTime(now);

        messageElement.innerHTML = `
                    <div class="message-header">
                        <span>${role === "user" ? "–í—ã" : "–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç"}</span>
                        <span class="message-time">${timeString}</span>
                    </div>
                    ${content}
                `;

        messagesContainer.appendChild(messageElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        return messageId;
      }

      // –û–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ
      function updateMessageInChat(messageId, newContent) {
        const messageElement = document.getElementById(messageId);
        if (messageElement) {
          const contentElement =
            messageElement.querySelector(".message-content") ||
            messageElement.lastChild;

          if (messageElement.lastChild.nodeType === Node.TEXT_NODE) {
            messageElement.insertAdjacentHTML("beforeend", newContent);
          } else {
            // –ï—Å–ª–∏ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–æ—á–µ—Ä–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç (–ø–æ—Å–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞)
            const children = messageElement.children;
            if (children.length > 1) {
              children[1].innerHTML = newContent;
            }
          }

          // –£–±—Ä–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–π ID
          messageElement.removeAttribute("id");
          messageElement.querySelector(".loading").remove();
        }
      }

      // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
      function updateStatus(status, text) {
        statusDot.className = "dot " + status;
        statusText.textContent = text;

        if (status === "connected") {
          isConnected = true;
        } else if (status === "disconnected") {
          isConnected = false;
        }
      }

      // –ü–æ–∫–∞–∑–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      function showSystemMessage(message) {
        systemMessageText.innerHTML = message;
        systemMessage.classList.remove("hidden");
        errorMessage.classList.add("hidden");

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
          systemMessage.classList.add("hidden");
        }, 5000);
      }

      // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
      function showError(message) {
        errorMessageText.textContent = message;
        errorMessage.classList.remove("hidden");
        systemMessage.classList.add("hidden");

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
          errorMessage.classList.add("hidden");
        }, 5000);
      }

      // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ localStorage
      function saveSettings() {
        const settings = {
          apiUrl: apiUrlInput.value.trim(),
          model: modelInput.value.trim(),
          systemPrompt: systemPromptInput.value.trim(), // –î–æ–±–∞–≤–∏—Ç—å system prompt
          temperature: temperatureInput.value,
          maxTokens: maxTokensInput.value,
          selectedTemplateId: currentTemplateId, // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω
        };

        localStorage.setItem("llmChatSettings", JSON.stringify(settings));
      }

      // –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ localStorage
      function loadSettings() {
        const savedSettings = localStorage.getItem("llmChatSettings");
        if (savedSettings) {
          try {
            const settings = JSON.parse(savedSettings);

            if (settings.apiUrl) apiUrlInput.value = settings.apiUrl;
            if (settings.model) modelInput.value = settings.model;
            if (settings.systemPrompt)
              systemPromptInput.value = settings.systemPrompt; // –ó–∞–≥—Ä—É–∑–∏—Ç—å system prompt
            if (settings.temperature)
              temperatureInput.value = settings.temperature;
            if (settings.maxTokens) maxTokensInput.value = settings.maxTokens;

            // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω
            if (settings.selectedTemplateId) {
              const template = promptTemplates.find(
                (t) => t.id === settings.selectedTemplateId
              );
              if (template) {
                // –ù–µ –ø—Ä–∏–º–µ–Ω—è—Ç—å —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–º–ø—Ç
                // –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –ø—Ä–æ—Å—Ç–æ –æ—Ç–º–µ—Ç–∏–º –µ–≥–æ –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω—ã–π
                currentTemplateId = settings.selectedTemplateId;
              }
            }

            updateTemperatureValue();
          } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:", e);
          }
        }
      }

      // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞
      function saveChatHistory() {
        if (conversationHistory.length > 0) {
          localStorage.setItem(
            "llmChatHistory",
            JSON.stringify(conversationHistory)
          );
        }
      }

      // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞
      function loadChatHistory() {
        const savedHistory = localStorage.getItem("llmChatHistory");
        if (savedHistory) {
          try {
            const history = JSON.parse(savedHistory);
            conversationHistory = history;

            // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –≤ —á–∞—Ç–µ (–∫—Ä–æ–º–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è)
            history.forEach((msg) => {
              if (msg.role === "user" || msg.role === "assistant") {
                addMessageToChat(msg.role, msg.content);
              }
            });

            // –ü–æ–¥—Å—á–∏—Ç–∞—Ç—å –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∏—Å—Ç–æ—Ä–∏–∏
            totalRequests = history.filter(
              (msg) => msg.role === "assistant"
            ).length;
            // –ü—Ä–∏–º–µ—Ä–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤: ~1.3 —Ç–æ–∫–µ–Ω–∞ –Ω–∞ —Å–∏–º–≤–æ–ª –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
            totalTokensUsed = Math.round(
              history.reduce((acc, msg) => acc + msg.content.length * 1.3, 0)
            );

            if (history.length > 0) {
              showSystemMessage(
                `–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ | ${totalRequests} –∑–∞–ø—Ä–æ—Å–æ–≤ | ~${totalTokensUsed} —Ç–æ–∫–µ–Ω–æ–≤ –≤—Å–µ–≥–æ`
              );
            }
          } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:", e);
          }
        }
      }

      // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Ä–µ–º—è
      function formatTime(date) {
        return date.toLocaleTimeString("ru-RU", {
          hour: "2-digit",
          minute: "2-digit",
          hour12: false,
        });
      }

      function showStatistics() {
        const avgTokensPerRequest =
          totalRequests > 0 ? Math.round(totalTokensUsed / totalRequests) : 0;

        const statsHtml = `
        <div style="padding: 15px; background: rgba(45, 55, 72, 0.9); border-radius: 8px; margin-top: 10px;">
          <h3 style="margin-bottom: 10px;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div>
              <div style="font-size: 0.9rem; color: #a0aec0;">–í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤:</div>
              <div style="font-size: 1.2rem; font-weight: bold;">${totalRequests}</div>
            </div>
            <div>
              <div style="font-size: 0.9rem; color: #a0aec0;">–í—Å–µ–≥–æ —Ç–æ–∫–µ–Ω–æ–≤:</div>
              <div style="font-size: 1.2rem; font-weight: bold;">${totalTokensUsed}</div>
            </div>
            <div>
              <div style="font-size: 0.9rem; color: #a0aec0;">–°—Ä–µ–¥–Ω–µ–µ –Ω–∞ –∑–∞–ø—Ä–æ—Å:</div>
              <div style="font-size: 1.2rem; font-weight: bold;">${avgTokensPerRequest}</div>
            </div>
            <div>
              <div style="font-size: 0.9rem; color: #a0aec0;">–í –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞:</div>
              <div style="font-size: 1.2rem; font-weight: bold;">${conversationHistory.length / 2}</div>
            </div>
          </div>
          <button onclick="resetStatistics()" style="
            width: 100%;
            margin-top: 15px;
            padding: 10px;
            background: #f56565;
          ">
            –°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
          </button>
        </div>
      `;

        showSystemMessage(statsHtml);
      }

      // –î–æ–±–∞–≤—å—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é resetStatistics():
      function resetStatistics() {
        if (confirm("–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è?")) {
          totalTokensUsed = 0;
          totalRequests = 0;
          updateStatus("disconnected", "–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ");
          showSystemMessage("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–±—Ä–æ—à–µ–Ω–∞");
        }
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
